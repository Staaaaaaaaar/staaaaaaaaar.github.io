<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.26" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.187" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"ICS - Arch Lab | 处理器太慢怎么办？","image":["https://staaaaaaaaar.github.io/blog/ics-archlab/execute-stage.png"],"dateModified":"2026-01-29T08:20:13.000Z","author":[]}</script><meta property="og:url" content="https://staaaaaaaaar.github.io/article/3lmjvpr0/"><meta property="og:site_name" content="Sam's Blog"><meta property="og:title" content="ICS - Arch Lab | 处理器太慢怎么办？"><meta property="og:description" content="在 Arch Lab 中，我们将熟悉流水线 Y86-64 处理器的设计与实现，并对该处理器及一个基准测试程序进行优化，以实现性能最大化。实验分为三个部分： Part A：编写一些简单的 Y86-64 程序，并熟悉 Y86-64 相关工具的使用。 Part B：为 SEQ 模拟器扩展新的指令并完善 CPU 流水线的实现过程。 Part C：对 Y86-6..."><meta property="og:type" content="article"><meta property="og:image" content="https://staaaaaaaaar.github.io/blog/ics-archlab/execute-stage.png"><meta property="og:locale" content="zh-CN"><meta property="og:locale:alternate" content="en-US"><meta property="og:updated_time" content="2026-01-29T08:20:13.000Z"><meta property="article:tag" content="ics"><meta property="article:tag" content="pku"><meta property="article:modified_time" content="2026-01-29T08:20:13.000Z"><link rel="alternate" hreflang="en-us" href="https://staaaaaaaaar.github.io/en/article/3lmjvpr0/"><link rel="icon" type="image/svg" href="/star.svg"><title>ICS - Arch Lab | 处理器太慢怎么办？ | Sam's Blog</title><meta name="description" content="在 Arch Lab 中，我们将熟悉流水线 Y86-64 处理器的设计与实现，并对该处理器及一个基准测试程序进行优化，以实现性能最大化。实验分为三个部分： Part A：编写一些简单的 Y86-64 程序，并熟悉 Y86-64 相关工具的使用。 Part B：为 SEQ 模拟器扩展新的指令并完善 CPU 流水线的实现过程。 Part C：对 Y86-6..."><link rel="preload" href="/assets/style-DPuO_-8u.css" as="style"><link rel="stylesheet" href="/assets/style-DPuO_-8u.css"><link rel="modulepreload" href="/assets/app-Db1faIqK.js"><link rel="modulepreload" href="/assets/index.html-DUXNItqu.js"><link rel="modulepreload" href="/assets/execute-stage-yg3Y2OR3.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-91d48f1e><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-96bb8152></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-96bb8152> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-91d48f1e data-v-09fff909><div class="vp-navbar" vp-navbar data-v-09fff909 data-v-bd13effa><div class="wrapper" data-v-bd13effa><div class="container" data-v-bd13effa><div class="title" data-v-bd13effa><div class="vp-navbar-title" data-v-bd13effa data-v-7e08aea3><a class="vp-link link no-icon title" href="/" data-v-7e08aea3><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="/star.svg" alt data-v-2b7ce57b><!--]--><!--[--><img class="vp-image light logo" style="" src="/star.svg" alt data-v-2b7ce57b><!--]--><!--]--><!--]--><span data-v-7e08aea3>Sam&#39;s Blog</span><!--[--><!--]--><!--]--></a></div></div><div class="content" data-v-bd13effa><div class="content-body" data-v-bd13effa><!--[--><!--]--><div class="vp-navbar-search search" data-v-bd13effa><div class="search-wrapper" data-v-de50fffc><!----><div id="local-search" data-v-de50fffc><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-de50fffc><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-bd13effa data-v-bed0a661><span id="main-nav-aria-label" class="visually-hidden" data-v-bed0a661>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-bed0a661 data-v-abd4fe28><!--[--><!----><span data-v-abd4fe28>首页</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-bed0a661 data-v-abd4fe28><!--[--><!----><span data-v-abd4fe28>博客</span><!----><!--]--></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-bed0a661 data-v-c1cd76bb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-c1cd76bb><span class="text" data-v-c1cd76bb><!----><!----><span data-v-c1cd76bb>笔记</span><!----><span class="vpi-chevron-down text-icon" data-v-c1cd76bb></span></span></button><div class="menu" data-v-c1cd76bb><div class="vp-menu" data-v-c1cd76bb data-v-a766b583><div class="items" data-v-a766b583><!--[--><!--[--><div class="vp-menu-link" data-v-a766b583 data-v-bcd5d0fa><a class="vp-link link" href="/FoG/intro/" data-v-bcd5d0fa><!--[--><!----> 地球介质力学基础 <!----><!--]--></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-a766b583 data-v-bcd5d0fa><a class="vp-link link" href="/GSP/gzium104/" data-v-bcd5d0fa><!--[--><!----> 地球物理信号处理 <!----><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!--[--><!--]--><div class="vp-flyout vp-navbar-translations translations" data-v-bd13effa data-v-71645a86 data-v-c1cd76bb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="选择语言" data-v-c1cd76bb><span class="text" data-v-c1cd76bb><!----><span class="vpi-languages option-icon" data-v-c1cd76bb></span><!----><!----><span class="vpi-chevron-down text-icon" data-v-c1cd76bb></span></span></button><div class="menu" data-v-c1cd76bb><div class="vp-menu" data-v-c1cd76bb data-v-a766b583><!----><!--[--><!--[--><div class="items" data-v-71645a86><p class="title" data-v-71645a86>简体中文</p><!--[--><div class="vp-menu-link" data-v-71645a86 data-v-bcd5d0fa><a class="vp-link link" href="/en/article/3lmjvpr0/" data-v-bcd5d0fa><!--[--><!----> English <!----><!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="vp-navbar-appearance appearance" data-v-bd13effa data-v-abe53c2d><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-abe53c2d data-v-659aa58c data-v-45c72a2c><span class="check" data-v-45c72a2c><span class="icon" data-v-45c72a2c><!--[--><span class="vpi-sun sun" data-v-659aa58c></span><span class="vpi-moon moon" data-v-659aa58c></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-bd13effa data-v-fb2c4367 data-v-802d5b24><!--[--><a class="vp-social-link no-icon" href="https://github.com/staaaaaaaaar" aria-label="github" title="github" target="_blank" rel="noopener" data-v-802d5b24 data-v-3dd1304a><!----></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-bd13effa data-v-b8b08987 data-v-c1cd76bb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-c1cd76bb><span class="vpi-more-horizontal icon" data-v-c1cd76bb></span></button><div class="menu" data-v-c1cd76bb><div class="vp-menu" data-v-c1cd76bb data-v-a766b583><!----><!--[--><!--[--><div class="group translations" data-v-b8b08987><p class="trans-title" data-v-b8b08987>简体中文</p><!--[--><div class="vp-menu-link" data-v-b8b08987 data-v-bcd5d0fa><a class="vp-link link" href="/en/article/3lmjvpr0/" data-v-bcd5d0fa><!--[--><!----> English <!----><!--]--></a></div><!--]--></div><div class="group" data-v-b8b08987><div class="item appearance" data-v-b8b08987><p class="label" data-v-b8b08987>外观</p><div class="appearance-action" data-v-b8b08987><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-b8b08987 data-v-659aa58c data-v-45c72a2c><span class="check" data-v-45c72a2c><span class="icon" data-v-45c72a2c><!--[--><span class="vpi-sun sun" data-v-659aa58c></span><span class="vpi-moon moon" data-v-659aa58c></span><!--]--></span></span></button></div></div></div><div class="group" data-v-b8b08987><div class="item social-links" data-v-b8b08987><div class="vp-social-links social-links-list" data-v-b8b08987 data-v-802d5b24><!--[--><a class="vp-social-link no-icon" href="https://github.com/staaaaaaaaar" aria-label="github" title="github" target="_blank" rel="noopener" data-v-802d5b24 data-v-3dd1304a><!----></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-bd13effa data-v-68a00901><span class="container" data-v-68a00901><span class="top" data-v-68a00901></span><span class="middle" data-v-68a00901></span><span class="bottom" data-v-68a00901></span></span></button></div></div></div></div><div class="divider" data-v-bd13effa><div class="divider-line" data-v-bd13effa></div></div></div><!----></header><!----><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-91d48f1e data-v-529950f9><div class="vp-doc-container is-posts" data-v-529950f9 data-v-9999e088><!--[--><!--]--><div class="container" data-v-9999e088><!----><div class="content" data-v-9999e088><div class="content-container" data-v-9999e088><!--[--><!--]--><main class="main" data-v-9999e088><nav class="vp-breadcrumb" data-v-9999e088 data-v-1578c953><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-1578c953><!--[--><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb" href="/" property="item" typeof="WebPage" data-v-1578c953><!--[-->首页<!--]--></a><span class="vpi-chevron-right" data-v-1578c953></span><meta property="name" content="首页" data-v-1578c953><meta property="position" content="1" data-v-1578c953></li><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-1578c953><!--[-->博客<!--]--></a><span class="vpi-chevron-right" data-v-1578c953></span><meta property="name" content="博客" data-v-1578c953><meta property="position" content="2" data-v-1578c953></li><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb" href="/article/categories/?id=9f50cc" property="item" typeof="WebPage" data-v-1578c953><!--[-->实验<!--]--></a><span class="vpi-chevron-right" data-v-1578c953></span><meta property="name" content="实验" data-v-1578c953><meta property="position" content="3" data-v-1578c953></li><li property="itemListElement" typeof="ListItem" data-v-1578c953><a class="vp-link link no-icon breadcrumb current" href="/article/3lmjvpr0/" property="item" typeof="WebPage" data-v-1578c953><!--[-->ICS - Arch Lab | 处理器太慢怎么办？<!--]--></a><!----><meta property="name" content="ICS - Arch Lab | 处理器太慢怎么办？" data-v-1578c953><meta property="position" content="4" data-v-1578c953></li><!--]--></ol></nav><!--[--><!--]--><!--[--><div class="vp-doc-title" data-v-911c4096><!--[--><!--]--><h1 class="page-title" data-v-911c4096><!----> ICS - Arch Lab | 处理器太慢怎么办？ <!----></h1><!--[--><!--]--></div><div class="vp-doc-meta" data-v-911c4096><!--[--><!--]--><p class="reading-time" data-v-911c4096><span class="vpi-books icon" data-v-911c4096></span><span data-v-911c4096>约 8012 字</span><span data-v-911c4096>大约 27 分钟</span></p><p data-v-911c4096><span class="vpi-tag icon" data-v-911c4096></span><!--[--><a class="vp-link link tag vp-tag-2vft" href="/article/tags/?tag=pku" data-v-911c4096><!--[-->pku<!--]--></a><a class="vp-link link tag vp-tag-cdrk" href="/article/tags/?tag=ics" data-v-911c4096><!--[-->ics<!--]--></a><!--]--></p><!--[--><!--]--><p class="create-time" data-v-911c4096><span class="vpi-clock icon" data-v-911c4096></span><span data-v-911c4096>2025-11-05</span></p></div><!--]--><!--[--><!--]--><!--[--><div class="_article_3lmjvpr0_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-9999e088><!--[--><!--]--><div data-v-9999e088><p>在 Arch Lab 中，我们将熟悉流水线 Y86-64 处理器的设计与实现，并对该处理器及一个基准测试程序进行优化，以实现性能最大化。实验分为三个部分：</p><ul><li>Part A：编写一些简单的 Y86-64 程序，并熟悉 Y86-64 相关工具的使用。</li><li>Part B：为 SEQ 模拟器扩展新的指令并完善 CPU 流水线的实现过程。</li><li>Part C：对 Y86-64 基准测试程序及其架构设计进行优化。</li></ul><h2 id="预备知识" tabindex="-1"><a class="header-anchor" href="#预备知识"><span>预备知识</span></a></h2><h3 id="y86-64-指令集架构" tabindex="-1"><a class="header-anchor" href="#y86-64-指令集架构"><span>Y86-64 指令集架构</span></a></h3><p>Y86-64 是基于 x86-64 简化而来的指令集，定义了指令格式、寄存器组、寻址方式及程序状态码，是 Arch Lab 中处理器设计的指令规范。</p><h3 id="hcl-硬件描述语言" tabindex="-1"><a class="header-anchor" href="#hcl-硬件描述语言"><span>HCL 硬件描述语言</span></a></h3><p>HCL 是用于描述硬件逻辑的简化语言，重点支持组合逻辑与时序逻辑表达，是实现处理器模拟器控制逻辑的核心工具。</p><h3 id="seq-架构" tabindex="-1"><a class="header-anchor" href="#seq-架构"><span>SEQ 架构</span></a></h3><p>SEQ 是基础的单周期处理器架构，每条指令的取指、译码、执行等阶段串行完成，是理解流水线架构的基础模型。</p><h3 id="pipe-架构" tabindex="-1"><a class="header-anchor" href="#pipe-架构"><span>PIPE 架构</span></a></h3><p>PIPE 是将指令执行拆解为多个流水线阶段并行处理的架构，可提升指令吞吐量，需解决数据冒险、控制冒险等关键问题。</p><h2 id="前置准备" tabindex="-1"><a class="header-anchor" href="#前置准备"><span>前置准备</span></a></h2><h3 id="环境配置" tabindex="-1"><a class="header-anchor" href="#环境配置"><span>环境配置</span></a></h3><p>参考指导文档进行环境配置。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --proto</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=https</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --tlsv1.2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -sSf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://sh.rustup.rs</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sh</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rustup</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1.90</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rustup</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1.90</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在每次更改 Rust 源码后，应重新构建项目。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> archlab-project</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cargo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> build</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="工具集" tabindex="-1"><a class="header-anchor" href="#工具集"><span>工具集</span></a></h3><p>构建项目后，将产生一个 <code>archlab-project/target</code> 文件夹来存储输出的二进制文件和其他中间文件。输出的可执行文件是：</p><ul><li>Y86-64 汇编器：target/debug/yas</li><li>Y86-64 调试器：target/debug/ydb</li><li>Y86-64 ISA 模拟器：target/debug/yis</li><li>Y86-64 流水线模拟器：target/debug/ysim</li><li>本地评分器：target/debug/grader</li></ul><p>可通过以下命令启动本地评分器：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> archlab-project</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cargo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> build</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./target/debug/grader</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> part-a</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./target/debug/grader</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> part-b</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./target/debug/grader</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> part-c</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./target/debug/grader</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> autolab</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其余工具详情可参看 <code>archlab-project/README.md</code>。</p><h3 id="git-init" tabindex="-1"><a class="header-anchor" href="#git-init"><span>git init</span></a></h3><p>为了便于管理代码版本，笔者建议在 <code>archlab-project</code> 目录下初始化一个 Git 仓库：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> archlab-project</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> init</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>用于追踪代码变更。</p><h2 id="part-a" tabindex="-1"><a class="header-anchor" href="#part-a"><span>Part A</span></a></h2><p>Part A 中，我们将在 <code>archlab-project/misc</code> 目录下开展工作。我们的任务是编写三个 Y86-64 程序实现三个函数。</p><h3 id="sum-ys" tabindex="-1"><a class="header-anchor" href="#sum-ys"><span>sum.ys</span></a></h3><p>参照给出的示例代码：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* linked list element */</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">typedef</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> struct</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ELE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    struct</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ELE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">list_ptr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* sum_list - Sum the elements of a linked list */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">long</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sum_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">list_ptr </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    val </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">-&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    ls </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">-&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是一段链表的求和函数，我们可以在 <code>sum.ys</code> 中编写如下 Y86-64 程序：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .pos </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                  ; 设置当前汇编地址为0（程序起始地址）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq stack, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      ; 初始化栈指针%rsp，指向stack标签处（栈起始地址）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> main               </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 调用main函数</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    halt                    </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 程序执行结束，停机</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .align </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                ; 后续数据按8字节对齐</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ele1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 链表第一个节点</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x00d</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad ele2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ele2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 链表第二个节点</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x0e0</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad ele3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ele3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 链表第三个节点</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xf00</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; main函数入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq ele1, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       ; 将第一个链表节点ele1的地址存入%rdi</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sum_list           </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 调用sum_list函数</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sum_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                   ; sum_list函数入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    xorq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 将%rax清零</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Loop</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:                       </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 遍历链表</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 检查%rdi是否为0</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Done                 </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 若%rdi为0（链表结束），跳转到Done</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     ; 从%rdi指向的地址（当前节点的val字段）读取值到%rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    addq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 将%rcx（当前节点val）加到%rax</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    ; 从%rdi+8地址（当前节点的next字段）读取下一个节点地址到%rdi</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jmp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> Loop</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                ; 跳回Loop，继续处理下一个节点</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Done</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 遍历结束</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .pos </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x200</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">              ; 设置栈的起始地址为0x200（确保栈有足够空间）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                      ; 栈起始位置标记</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="rsum-ys" tabindex="-1"><a class="header-anchor" href="#rsum-ys"><span>rsum.ys</span></a></h3><p>参照给出的示例代码：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* linked list element */</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">typedef</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> struct</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ELE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    struct</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ELE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">list_ptr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* rsum_list - Recursive version of sum_list */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">long</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> rsum_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">list_ptr </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">-&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> rest </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> rsum_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">-&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> rest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是一段链表的递归求和函数，我们可以在 <code>rsum.ys</code> 中编写如下 Y86-64 程序：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .pos </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                  ; 设置当前汇编地址为0（程序起始地址）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq stack, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      ; 初始化栈指针%rsp，指向stack标签处（栈起始地址）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> main               </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 调用main函数</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    halt                    </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 程序执行结束，停机</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .align </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                ; 后续数据按8字节对齐</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ele1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 链表第一个节点</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x00d</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad ele2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ele2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 链表第二个节点</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x0e0</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad ele3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ele3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 链表第三个节点</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xf00</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; main函数入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq ele1, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       ; 将第一个链表节点ele1的地址存入%rdi</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> rsum_list          </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 调用递归求和函数rsum_list</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rsum_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                  ; rsum_list函数入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 检查%rdi（当前链表节点地址）是否为0（判断是否为空节点）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Else                 </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 若为空节点（链表结束），跳转到Else（递归终止条件）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    pushq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">              ; 保存%rbx（被调用者保存寄存器，递归调用中需保留其值，避免被后续调用覆盖）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     ; 从当前节点（%rdi指向）的val字段读取值到%rbx（暂存当前节点的值）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    ; 从当前节点的next字段（%rdi+8地址）读取下一个节点地址到%rdi（更新参数为下一个节点）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> rsum_list          </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 递归调用rsum_list，计算剩余链表的和（结果将存于%rax）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    addq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 将当前节点的值（%rbx）加到剩余链表的和（%rax）中，得到当前链表的总和</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    popq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">               ; 恢复%rbx的值（从栈中弹出之前保存的值）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 返回当前计算的总和（结果在%rax中）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; 递归终止条件标签（空链表处理）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    xorq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 将%rax清零（空链表的和为0，作为递归的基线返回值）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 返回0（结果在%rax中）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .pos </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x200</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">              ; 设置栈的起始地址为0x200（确保栈有足够空间）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                      ; 栈起始位置标记</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="bubble-ys" tabindex="-1"><a class="header-anchor" href="#bubble-ys"><span>bubble.ys</span></a></h3><p>参照给出的示例代码：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* bubble_sort - Sort long numbers at data in ascending order */</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> bubble_sort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">long</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">     long</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">last</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">     for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">last </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> data </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> count </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> last </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> last</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">--</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">         for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> i </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> last</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">             if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                 long</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> t </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                 *</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">                 *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> t</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">             }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">         }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是一段冒泡排序函数，我们可以在 <code>bubble.ys</code> 中编写如下 Y86-64 程序：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .pos </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                  ; 设置当前汇编地址为0（程序起始地址）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq  stack, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsp</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     ; 初始化栈指针%rsp，指向stack标签处（栈起始地址）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> main               </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 调用main函数（跳转到main执行，返回地址压栈）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    halt                    </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 程序执行结束，停机</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .align </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                ; 后续数据按8字节对齐</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">array</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                      ; 待排序的数组（存储6个long类型元素）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xbca</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             ; 数组元素1：0xbca</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xcba</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             ; 数组元素2：0xcba</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xacb</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             ; 数组元素3：0xacb</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xcab</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             ; 数组元素4：0xcab</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xabc</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             ; 数组元素5：0xabc</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .quad </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0xbac</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             ; 数组元素6：0xbac</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 寄存器用途说明：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %rdi：存放数组起始地址data</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %rsi：存放数组元素个数count</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %rbx：存放当前内层循环变量i（地址）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %rcx：存放外层循环变量last（地址）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %rdx：临时变量（用于计算、比较等）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %r9：常量1（用于减法运算）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %r10：常量8（每个long元素占8字节，用于地址偏移计算）</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; %r11、%r12：临时存放数组元素（用于比较和交换）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">bubble_sort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                ; 冒泡排序函数入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          ; 初始化%r9为1（用于count-1等减法）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 初始化%r10为8（每个元素8字节，地址偏移量）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rrmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       ; 将数组起始地址data复制到%rcx（用于计算last初始地址）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rrmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       ; 将元素个数count复制到%rdx（临时存储count）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    subq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          ; %rdx = count - 1（计算last的索引偏移量）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Loop_1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 计算last初始地址的循环（last = data + (count-1)*8）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 检查%rdx（剩余偏移次数）是否为0</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Loop_2               </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 若偏移次数为0，说明last初始地址计算完成，跳至外层循环入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    addq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; %rcx += 8（每次偏移一个元素地址，累计(count-1)次）</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    subq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">          ; %rdx -= 1（剩余偏移次数减1）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jmp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Loop_1              </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 继续循环计算last地址</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Loop_2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 外层循环入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rrmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       ; 将当前last地址复制到%rdx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    subq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; %rdx = last - data（计算last与数组起始地址的偏移）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Done_2              </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 若偏移&lt;=0（last &lt;= data），外层循环结束，跳至Done_2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rrmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       ; 初始化内层循环变量i为data（%rbx = data）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Loop_3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 内层循环入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rrmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       ; 将当前last地址复制到%rdx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    subq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; %rdx = last - i（计算i与last的偏移）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Done_3              </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 若偏移&lt;=0（i &gt;= last），内层循环结束，跳至Done_3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     ; 读取i指向的元素：%r11 = *i</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    ; 读取i+1指向的元素：%r12 = *(i+1)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    subq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 计算*i - *(i+1)（用于比较大小）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Else                </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 若*i &lt;= *(i+1)，无需交换，跳至Else</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     ; 重新读取*i</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    ; 重新读取*(i+1)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)    </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 将*i存入i+1的位置：*(i+1) = *i</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)     </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 将*(i+1)存入i的位置：*i = *(i+1)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    addq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; i += 1（地址加8，移动到下一个元素）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jmp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Loop_3              </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 跳回内层循环，继续下一次迭代</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Done_3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 内层循环结束</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    subq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; last -= 1（地址减8，移动到前一个元素）</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jmp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Loop_2              </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 跳回外层循环，继续下一次迭代</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Done_2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 外层循环结束</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 从bubble_sort函数返回</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                       ; main函数入口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq array, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      ; 将数组起始地址array存入%rdi</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$6</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">         ; 将元素个数6存入%rsi</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    call</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> bubble_sort        </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">; 调用冒泡排序函数bubble_sort</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                     ; 从main函数返回（返回到call main的下一条指令，即halt）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    .pos </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0x200</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">              ; 设置栈的起始地址为0x200（确保栈有足够空间）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                      ; 栈起始位置标记</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="part-b" tabindex="-1"><a class="header-anchor" href="#part-b"><span>Part B</span></a></h2><p>Part B 中，我们将在 <code>archlab-project/sim/src/architectures/extra</code> 目录下开展工作。我们的任务是逐步完善一系列处理器架构。它们均使用 HCL 语言描述，我们只需修改相应的占位符为正确的表达式。占位符一共有三种：</p><ul><li><strong>BOOL_PLACEHOLDER</strong></li><li><strong>U8_PLACEHOLDER</strong></li><li><strong>U64_PLACEHOLDER</strong></li></ul><h3 id="seq-full-rs" tabindex="-1"><a class="header-anchor" href="#seq-full-rs"><span>seq_full.rs</span></a></h3><p>在 <code>seq_full.rs</code> 中，我们需要扩展 SEQ 处理器以支持以下指令：</p><ul><li>iopq V, rB</li></ul><p>Fetch 阶段，需要保证 IOPQ 是一条有效指令，需要读取寄存器和立即数。</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> instr_valid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // CMOVX is the same as RRMOVQ</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> NOP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> HALT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RMMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> MRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    OPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> PUSHQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> POPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Does fetched instruction require a regid byte?</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> need_regids</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> OPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> PUSHQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> POPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RMMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> MRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Does fetched instruction require a constant word?</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> need_valC </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RMMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> MRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Decode 阶段，与 OPQ 指令类似，需要将 rB 设置为 srcB 从寄存器文件中取值，并将写入地址 dstE 设置为 rB。</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// What register should be used as the B source?</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> srcB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> OPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RMMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> MRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ialign</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">rB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> PUSHQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> POPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RSP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    true</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // Don&#39;t need register</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// What register should be used as the E destination?</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ialign</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">rB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> OPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ialign</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">rB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> PUSHQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> POPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RSP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    true</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // Don&#39;t write any register</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Execute 阶段，需要指定 ALU 的输入，并更新条件码。</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Select input A to ALU</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> aluA </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> OPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_read</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RMMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> MRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ialign</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> PUSHQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> NEG_8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> POPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Other instructions don&#39;t need ALU</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Select input B to ALU</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> aluB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RMMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> MRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> OPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">              PUSHQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> POPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_read</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IRMOVQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Other instructions don&#39;t need ALU</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Set the ALU function</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> alufun</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> OPQ</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ifun</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ifun</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    true</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> ADD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Should the condition codes be updated?</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> set_cc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> icode</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> OPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> IOPQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其余阶段无需调整。</p><h3 id="pipe-s3a-rs" tabindex="-1"><a class="header-anchor" href="#pipe-s3a-rs"><span>pipe_s3a.rs</span></a></h3><p>在 <code>pipe_s3a.rs</code> 中，我们需要在 <code>pipe_s2.rs</code> 的基础上进一步优化。我们发现 <code>pipe_s2</code> 的关键路径长度为 7，而计算 <code>f_pc</code> 的依赖路径过长。为了减少 <code>f_pc</code> 的依赖路径长度，我们进一步拆分了流水线阶段，将解码阶段与随后执行、存储和写回阶段分开。然而，这样做引入了新的问题：</p><ul><li><p><code>reg_read</code> 和 <code>reg_write</code> 现在位于不同的流水线阶段，这可能导致数据冒险。</p></li><li><p>用于计算 <code>f_pc</code> 的操作数也被拆分到不同的流水线阶段，这实际上是不正确的，因为在特定时间点位于不同流水线阶段的值属于不同的指令。</p></li></ul><p>为了解决上述问题，我们在必要时对流水线寄存器实施阻塞或冒泡控制，确保等待一个额外的周期以保证计算结果的正确性。</p><p><code>pipe_s3a.rs</code> 的占位符修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Call.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // If the previous instruction is CALL, the constant value should be the next PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valC is from Fetch Stage, thus the last cycle</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Taken branch.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == JX &amp;&amp; e_cnd : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Completion of RET instruction.  Use value from stack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valM is from DEMW stage, thus the current cycle</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == RET : e_valM;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Default: Use incremented PC</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> F</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:======================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Execute Stage (Execute)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :==========================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == CMOVX &amp;&amp; !BOOL_PLACEHOLDER : RNONE;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a data hazard occurs, we need to wait for the data to be written to the</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// registers before proceeding.</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> data_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_srcA </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // || U8_PLACEHOLDER != RNONE &amp;&amp; BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ||</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_srcB </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool f_stall = D.icode in { JX, RET } || BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> data_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_stall = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> data_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pipe-s3b-rs" tabindex="-1"><a class="header-anchor" href="#pipe-s3b-rs"><span>pipe_s3b.rs</span></a></h3><p>在 <code>pipe_s3b.rs</code> 中，我们需要在 <code>pipe_s3a.rs</code> 的基础上进一步优化。<code>pipe_s3a</code> 的一个问题是停顿和气泡的频率太高，这实际上降低了性能。除了使用停顿和气泡来处理数据冒险之外，也可以通过转发来解决。</p><p><code>pipe_s3b.rs</code> 的占位符修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Call.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // If the previous instruction is CALL, the constant value should be the next PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valC is from Fetch Stage, thus the last cycle</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Taken branch.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == JX &amp;&amp; e_cnd : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Completion of RET instruction.  Use value from stack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valM is from DEMW stage, thus the current cycle</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == RET : e_valM;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Default: Use incremented PC</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> F</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Decode</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valA </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valE;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valM;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_read</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_read</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:======================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Execute Stage (Execute)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :==========================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == CMOVX &amp;&amp; !BOOL_PLACEHOLDER : RNONE;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool f_stall = D.icode in { U8_PLACEHOLDER, U8_PLACEHOLDER };</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_bubble = D.icode in { U8_PLACEHOLDER, U8_PLACEHOLDER };</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pipe-s3c-rs" tabindex="-1"><a class="header-anchor" href="#pipe-s3c-rs"><span>pipe_s3c.rs</span></a></h3><p>在 <code>pipe_s3c.rs</code> 中，我们需要在 <code>pipe_s3b.rs</code> 的基础上进一步优化。<code>pipe_s3b</code> 的性能提升不是很显著，因为当遇到 JX 指令时，我们总是会停顿/产生气泡。实际上，我们在解码阶段就已知两种分支选项，只是必须等到执行阶段才能确定选择哪条分支，我们可以基于此实现分支预测。</p><p><code>pipe_s3c.rs</code> 的占位符修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Call.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // If the previous instruction is CALL, the constant value should be the next PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valC is from Fetch Stage, thus the last cycle</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Branch misprediction.  Use incremental PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == JX &amp;&amp; !e_cnd : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Completion of RET instruction.  Use value from stack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valM is from DEMW stage, thus the current cycle</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == RET : e_valM;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Default: Use predicted PC</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> F</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pred_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Decode</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valA </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valE;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valM;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_read</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_read</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:======================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Execute Stage (Execute)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :==========================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == CMOVX &amp;&amp; !BOOL_PLACEHOLDER : RNONE;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a branch misprediction is detected during the Execute stage, it means that</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction currently in the Decode stage is invalid. Therefore, the next</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// cycle’s Execute stage needs to insert a bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool branch_mispred = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If both a branch misprediction and a RET hazard occur at the same time, since</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the jump instruction is executed before the RET, the RET should not have been</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// executed, so a stall is not needed.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool f_stall = BOOL_PLACEHOLDER &amp;&amp; !BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If both a branch misprediction and a ret hazard occur at the same time,</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// since the jump instruction is executed before the RET, the RET should not</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// have been executed. Therefore, a bubble is not needed.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_bubble = BOOL_PLACEHOLDER &amp;&amp; !BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pipe-s3d-rs" tabindex="-1"><a class="header-anchor" href="#pipe-s3d-rs"><span>pipe_s3d.rs</span></a></h3><p>在 <code>pipe_s3d.rs</code> 中，我们需要在 <code>pipe_s3c.rs</code> 的基础上进一步优化。从 <code>pipe_s3c</code> 到 <code>pipe_s3d</code> 的主要变化在于硬件设计。我们将寄存器读取和写入合并到一个名为 <code>reg_file</code> 的设备中，操作顺序为先写后读。此更改的目的是为了避免结构风险。</p><p><code>pipe_s3d.rs</code> 的占位符修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Call.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // If the previous instruction is CALL, the constant value should be the next PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valC is from Fetch Stage, thus the last cycle</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Branch misprediction.  Use incremental PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == JX &amp;&amp; !e_cnd : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Completion of RET instruction.  Use value from stack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valM is from DEMW stage, thus the current cycle</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == RET : e_valM;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Default: Use predicted PC</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> F</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pred_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Decode</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valA </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valE;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valM;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:======================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Execute Stage (Execute)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :==========================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == CMOVX &amp;&amp; !BOOL_PLACEHOLDER : RNONE;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a branch misprediction is detected during the Execute stage, it means that</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction currently in the Decode stage is invalid. Therefore, the next</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// cycle’s Execute stage needs to insert a bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool branch_mispred = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If both a branch misprediction and a RET hazard occur at the same time, since</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the jump instruction is executed before the RET, the RET should not have been</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// executed, so a stall is not needed.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool f_stall = BOOL_PLACEHOLDER &amp;&amp; !BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If both a branch misprediction and a ret hazard occur at the same time,</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// since the jump instruction is executed before the RET, the RET should not</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// have been executed. Therefore, a bubble is not needed.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_bubble = BOOL_PLACEHOLDER &amp;&amp; !BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pipe-s4a-rs" tabindex="-1"><a class="header-anchor" href="#pipe-s4a-rs"><span>pipe_s4a.rs</span></a></h3><p>在 <code>pipe_s4a.rs</code> 中，我们需要在 <code>pipe_s3d.rs</code> 的基础上进一步优化。为了进一步减少计算依赖层级，我们已经将执行阶段与其他阶段分离。实际上，通过在 <code>pipe_s3d</code> 中强制对寄存器执行先写后读的顺序，我们可以避免可能在 <code>pipe_s4</code> 中发生的结构性冒险。</p><p><code>pipe_s4a.rs</code> 的占位符修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Call.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // If the previous instruction is CALL, the constant value should be the next PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valC is from Fetch Stage, thus the last cycle</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Branch misprediction.  Use incremental PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == JX &amp;&amp; !e_cnd : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Completion of RET instruction.  Use value from stack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valM is from DEMW stage, thus the current cycle</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == RET : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Default: Use predicted PC</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> F</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pred_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Decode</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valA </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valE;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Execute</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == CMOVX &amp;&amp; !BOOL_PLACEHOLDER : RNONE;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a branch misprediction is detected during the Execute stage, it means that</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction currently in the Decode stage is invalid. Therefore, the next</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// cycle’s Execute stage needs to insert a bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool branch_mispred = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a RET instruction is detected in either the Decode or Execute stage, then</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction in the current Fetch stage is invalid. Therefore, a bubble</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// needs to be inserted in the Fetch stage for the next cycle.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// In fact, when E.icode == RET, the instruction in the current Decode stage is</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// also invalid, but because the D.icode in the previous cycle was RET, at this</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// point D.icode == NOP, so there&#39;s no need to add a condition for e_bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool ret_harzard = RET in { U8_PLACEHOLDER, U8_PLACEHOLDER };</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If both a branch misprediction and a RET hazard occur at the same time,</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// since the jump instruction is executed before the RET, the RET should not be</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// executed, so no stall is required.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool f_stall = BOOL_PLACEHOLDER &amp;&amp; !BOOL_PLACEHOLDER || BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">branch_mispred</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_stall = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If both a branch misprediction and a RET hazard occur at the same time,</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// since the jump instruction is executed before the RET, the RET should not</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// have been executed, so a bubble is not needed.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Actually, ret_harzard and d_stall cannot be true at the same time.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_bubble = BOOL_PLACEHOLDER &amp;&amp; !BOOL_PLACEHOLDER &amp;&amp; !d_stall;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">branch_mispred</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">d_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool e_bubble = branch_mispred || BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pipe-s4b-rs" tabindex="-1"><a class="header-anchor" href="#pipe-s4b-rs"><span>pipe_s4b.rs</span></a></h3><p>在 <code>pipe_s4b.rs</code> 中，我们需要在 <code>pipe_s4a.rs</code> 的基础上进一步优化。我们注意到用于计算 <code>f_pc</code> 的 <code>e_cnd</code> 的依赖路径太长。因此，我们可以将 <code>e_cnd</code> 存储在存储阶段寄存器中，并用 <code>M.cnd</code> 替代它。</p><p><code>pipe_s4b.rs</code> 的占位符修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Call.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // If the previous instruction is CALL, the constant value should be the next PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valC is from Fetch Stage, thus the last cycle</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Branch misprediction.  Use incremental PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == JX &amp;&amp; !M.cnd : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cnd </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Completion of RET instruction.  Use value from stack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valM is from DEMW stage, thus the current cycle</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == RET : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Default: Use predicted PC</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> F</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pred_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Decode</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valA </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valE;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Execute</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == CMOVX &amp;&amp; !BOOL_PLACEHOLDER : RNONE;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a branch misprediction is detected during the Execute stage, it means that</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction currently in the Decode stage is invalid. Therefore, the next</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// cycle’s Execute stage needs to insert a bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool branch_mispred = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a RET instruction is detected in either the Decode or Execute stage, then</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction in the current Fetch stage is invalid. Therefore, a bubble</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// needs to be inserted in the Fetch stage for the next cycle.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// In fact, when E.icode == RET, the instruction in the current Decode stage is</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// also invalid, but because the D.icode in the previous cycle was RET, at this</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// point D.icode == NOP, so there&#39;s no need to add a condition for e_bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool ret_harzard = RET in { U8_PLACEHOLDER, U8_PLACEHOLDER };</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Unlike in `pipe_s4a`, here we do not need to consider the case of branch</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// misprediction (since in the next cycle, Fetch will always get the `f_pc`</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// from `M.valP`).</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool f_stall = BOOL_PLACEHOLDER || BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_stall = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Unlike in `pipe_s4a`, when a branch misprediction occurs, we directly insert</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// a bubble, because the instruction in the Fetch stage at that point is invalid.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Actually, ret_harzard and d_stall cannot be true at the same time.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_bubble = BOOL_PLACEHOLDER || BOOL_PLACEHOLDER &amp;&amp; !d_stall;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">d_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool e_bubble = branch_mispred || BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pipe-s4c-rs" tabindex="-1"><a class="header-anchor" href="#pipe-s4c-rs"><span>pipe_s4c.rs</span></a></h3><p>在 <code>pipe_s4c.rs</code> 中，我们需要在 <code>pipe_s4b.rs</code> 的基础上进一步优化。类似于 <code>pipe_std.rs</code>，我们在解码阶段将 D.valP 输入到 d_valA 中，以消除执行和存储阶段流水线寄存器中的 valP。</p><p><code>pipe_s4c.rs</code> 的占位符修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Call.  Use instruction constant</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // If the previous instruction is CALL, the constant value should be the next PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valC is from Fetch Stage, thus the last cycle</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Branch misprediction.  Use incremental PC</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == JX &amp;&amp; !M.cnd : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cnd </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Completion of RET instruction.  Use value from stack</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // valM is from DEMW stage, thus the current cycle</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == RET : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // Default: Use predicted PC</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> F</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pred_pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Decode</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valA </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CALL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : e_valE;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // d_srcA == U8_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcA </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valB </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // BOOL_PLACEHOLDER : U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_valE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    d_srcB </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_dstM </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> m_valM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_file</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Execute</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> e_dstE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // U8_PLACEHOLDER == CMOVX &amp;&amp; !BOOL_PLACEHOLDER : RNONE;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CMOVX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Memory</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// We&#39;ve feed D.valP into d_valA. Thus M.valP is not needed.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// u64 mem_data = U64_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u64</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> mem_data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> M</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a branch misprediction is detected during the Execute stage, it means that</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction currently in the Decode stage is invalid. Therefore, the next</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// cycle’s Execute stage needs to insert a bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool branch_mispred = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> JX</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e_cnd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// If a RET instruction is detected in either the Decode or Execute stage, then</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// the instruction in the current Fetch stage is invalid. Therefore, a bubble</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// needs to be inserted in the Fetch stage for the next cycle.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// In fact, when E.icode == RET, the instruction in the current Decode stage is</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// also invalid, but because the D.icode in the previous cycle was RET, at this</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// point D.icode == NOP, so there&#39;s no need to add a condition for e_bubble.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool ret_harzard = RET in { U8_PLACEHOLDER, U8_PLACEHOLDER };</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RET</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> D</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">icode </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Unlike in `pipe_s4a`, here we do not need to consider the case of branch</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// misprediction (since in the next cycle, Fetch will always get the `f_pc`</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// from `M.valP`).</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool f_stall = BOOL_PLACEHOLDER || BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> f_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_stall = BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Unlike in `pipe_s4a`, when a branch misprediction occurs, we directly insert</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// a bubble, because the instruction in the Fetch stage at that point is invalid.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// Actually, ret_harzard and d_stall cannot be true at the same time.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool d_bubble = BOOL_PLACEHOLDER || BOOL_PLACEHOLDER &amp;&amp; !d_stall;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ret_harzard</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">d_stall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// bool e_bubble = branch_mispred || BOOL_PLACEHOLDER;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">bool</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e_bubble</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> branch_mispred</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> load_use_harzard</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="part-c" tabindex="-1"><a class="header-anchor" href="#part-c"><span>Part C</span></a></h2><p>Part C 中，我们将在 <code>archlab-project/misc</code> 和 <code>archlab-project/sim/src/architectures/extra</code> 目录下开展工作。我们的任务是修改 <code>archlab-project/misc/ncopy.ys</code> 和 <code>archlab-project/sim/src/architectures/extra/ncopy.rs</code>，让 <code>ncopy</code> 运行得尽可能快。最终性能将根据 cpe 和 ac 来评估。</p><ul><li>cpe (cycles per element)：如果模拟代码需要 C 个周期来复制一个包含 N 个元素的块，那么 CPE 就是 C/N。</li><li>ac (architecture cost)：ncopy 架构的关键路径长度。形式上，CPU 架构的关键路径是时钟元件之间组合逻辑的最长路径。关键路径的长度可以用来衡量 CPU 的时钟频率，从而用于估算架构性能。在 Part C 中，关键路径的长度简化为：1 加上在架构路径中排列的硬件设备（单元）的最大数量。</li></ul><p>ncopy 的 C 语言描述在 <code>misc/ncopy.c</code> 中。ncopy 函数将一个长度为 len 的整数数组 src 复制到一个不重叠的 dst 中，并返回 src 中正整数的数量。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">stdio.h</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">typedef</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> unsigned</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> long</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> word_t</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">word_t</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> src</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">],</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> dst</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* $begin ncopy */</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/*</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * ncopy - copy src to dst, returning number of positive ints</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> * contained in src array.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> */</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">word_t</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ncopy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">word_t</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">src</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> word_t</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">dst</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> word_t</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  word_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> count </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  word_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">len </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    val </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">src</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    *</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dst</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">val </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      count</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    len</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">--</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/* $end ncopy */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  word_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> i </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    src</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> i </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  count </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ncopy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">src</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> dst</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">count=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">%d\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  exit</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="应用-pipe-架构" tabindex="-1"><a class="header-anchor" href="#应用-pipe-架构"><span>应用 PIPE 架构</span></a></h3><p>由于 <code>ncopy.rs</code> 初始是 SEQ 架构，我们用 <code>archlab-project/sim/src/architectures/builtin/pipe_std.rs</code> 的内容完整替换 <code>ncopy.rs</code> 文件的内容。初步优化处理器架构，减少 ac。</p><h3 id="添加-iopq-指令" tabindex="-1"><a class="header-anchor" href="#添加-iopq-指令"><span>添加 IOPQ 指令</span></a></h3><p>查看 <code>ncopy.ys</code> 中的初始汇编代码。</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">################################################################################</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ncopy.ys - Copy a src block of len words to dst.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Return the number of positive words (&gt;0) contained in src.</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">################################################################################</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Do not modify this portion</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Function prologue.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># %rdi = src, %rsi = dst, %rdx = len</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ncopy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">################################################################################</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># You can modify this portion</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # Loop header</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    xorq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      # count = 0;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      # len &lt;= 0?</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Done           </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # if so, goto Done:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Loop</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # read val from src...</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # ...and store it to dst</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # val &lt;= 0?</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Npos           </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # if so, goto Npos:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    addq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # count++</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Npos</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    subq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # len--</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    irmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    addq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # src++</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    addq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # dst++</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      # len &gt; 0?</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jg</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> Loop</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             # if so, goto Loop:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Done</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># In grader, we will add a &quot;trap: jmp trap&quot; here, which traps your program in an</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># infinite loop. Thus your function should always return instead of falling</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># through till the end of the source code :)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发现每次进行 count++ 时，都需要先 irmovq 将立即数 1 加载到寄存器中，然后再进行加法操作。我们可以使用 IOPQ 指令来直接将立即数与寄存器相加，从而减少指令数量和执行时间。为此，我们需要在 <code>ncopy.rs</code> 中添加 IOPQ 指令。具体步骤可参考 Part B 部分针对 seq_full.rs 的修改。</p><h3 id="循环展开" tabindex="-1"><a class="header-anchor" href="#循环展开"><span>循环展开</span></a></h3><p>至此，我们已经将架构从 SEQ 升级到了 PIPE，并通过 IOPQ 指令减少了指令数量。进一步观察发现，每一次循环最后都需要经历一次条件跳转，这意味着每次循环都要经历控制冒险，但却只处理了一个元素。我们可以通过循环展开，在一次循环中处理多个元素来进一步提升 cpe。</p><p>循环展开参考代码如下：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Loop</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">72</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L2</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L3</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L4</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L5</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L6</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L6</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L7</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L7</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L8</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L9</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L9</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L10</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L10</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">72</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> N</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">N</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$80</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # src++</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$80</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # dst++</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    isubq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # len--</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jge</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> Loop</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            # if so, goto Loop</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="余数二分处理" tabindex="-1"><a class="header-anchor" href="#余数二分处理"><span>余数二分处理</span></a></h3><p>循环展开带来的问题是当 len 不是展开倍数时，剩余的元素无法通过展开后的循环处理。为了解决这个问题，我们需要针对不同的余数情况编写不同的处理代码，形成类似跳转表的结构。为了避免代码重复和过多的跳转，我们可以针对每个剩余的元素编写处理代码，Rk 对应对第 k 个剩余元素的处理，然后将这些代码块按照从大到小串联起来。对于不同的余数情况，我们只需要跳转到对应的 Rk 代码块即可，程序会顺序执行后续的对第 k-1、k-2、...、1 个剩余元素的处理代码。</p><p>余数处理参考代码如下：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">R9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> R8</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">R8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R7</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R7</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R6</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R6</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R5</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R4</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R3</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R2</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Done</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意这里将 andq 指令插入到 mrmovq 和 rmmovq 之间，从而避免了流水线暂停。</p><p>至于跳转部分，我们可以对余数反复减一并判断是否为零来跳转到对应的代码块。也可以选择使用二分思想来减少跳转次数。</p><p>完整 <code>ncopy.ys</code> 参考代码如下：</p><div class="language-asm line-numbers-mode" data-highlighter="shiki" data-ext="asm" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-asm"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">################################################################################</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ncopy.ys - Copy a src block of len words to dst.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Return the number of positive words (&gt;0) contained in src.</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">################################################################################</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Do not modify this portion</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Function prologue.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># %rdi = src, %rsi = dst, %rdx = len</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ncopy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">################################################################################</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># You can modify this portion</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # Loop header</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    xorq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      # count = 0;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    isubq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jl</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Loop</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">72</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L2</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L3</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rbp</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L4</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r8</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L5</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r9</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L6</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L6</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r10</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L7</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L7</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r11</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L8</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r12</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L9</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L9</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r13</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> L10</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">L10</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">72</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">r14</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> N</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">N</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$80</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # src++</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$80</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # dst++</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    isubq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # len--</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jge</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> Loop</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            # if so, goto Loop</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$10</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Done</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    isubq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$5</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R5</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jg</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R6_9</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R1_4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$2</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jl</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R1_2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R3_4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R3</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jmp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R4</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R1_2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R2</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jmp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R6_9</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    isubq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$2</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jg</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R8_9</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R6_7</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R7</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jmp</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R6</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R8_9</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    isubq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdx</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    je</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> R8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">R9</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">64</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> R8</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">R8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">56</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R7</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R7</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">48</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R6</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R6</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">40</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R5</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">32</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R4</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">24</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R3</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R2</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">8</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> R1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">R1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    mrmovq (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rdi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">), %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    andq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    rmmovq %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rcx</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, (%</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rsi</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    jle</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Done</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    iaddq </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">$1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, %</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">rax</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Done</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    ret</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># In grader, we will add a &quot;trap: jmp trap&quot; here, which traps your program in an</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># infinite loop. Thus your function should always return instead of falling</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># through till the end of the source code :)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="减少关键路径长度" tabindex="-1"><a class="header-anchor" href="#减少关键路径长度"><span>减少关键路径长度</span></a></h3><p>目前我们的 <code>ncopy.rs</code> 采用的是 PIPE 架构，关键路径长度为 4，正是执行阶段 e_cnd 的依赖路径。</p><figure><img src="/blog/ics-archlab/execute-stage.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>回忆 dstE 需要 e_cnd 更新的情况，为条件传送 CMOVX 指令。而 CMOVX 指令并不更新条件码。由此可知，更新条件码和需要计算 e_cnd 更新 dstE 的情况不会在执行阶段同时发生。因此，我们可以在执行阶段寄存器中新增 pre_cc 记录上一条指令的条件码，用于通过 cond 单元计算 e_cnd，从而降低关键路径长度为 3。</p><p><code>ncopy.rs</code> 参考修改如下：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-rust"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">crate</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">::</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">define_stages!</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">    ExecuteStage</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        stat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stat</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Bub</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> icode</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> NOP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ifun</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        valC</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u64</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        valA</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u64</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> valB</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u64</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        dstE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> dstM</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        srcA</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> srcB</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> u8</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> RNONE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        pre_cc</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> ConditionCode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> CC_INIT</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sim_macro</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">::</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">hcl!</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Fetch</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :================================:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:======================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Decode</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> and</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Write</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Back</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :======================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">@</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set_stage</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    icode</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_icode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    ifun</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_ifun</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    stat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d_stat</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    valC</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    srcA</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_srcA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    srcB</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_srcB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    valA</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valA</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    valB</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_valB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    dstE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_dstE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    dstM</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> d_dstM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    pre_cc</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">});</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Execute</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :==============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">ConditionCode</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> cc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reg_cc</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">u8</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e_ifun</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ifun</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">ConditionCode</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pre_cc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pre_cc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">@</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set_input</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">cond</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    cc</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pre_cc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    condfun</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> e_ifun</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">});</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:==============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Memory</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :==============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Write</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Back</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Stage</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :============================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:========================:</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Pipeline</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Register</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Control</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :========================</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// ...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><a href="https://arthals.ink/blog/arch-lab" target="_blank" rel="noopener noreferrer">更适合北大宝宝体质的 Arch Lab 踩坑记</a></p><p><a href="https://mcginn7.github.io/2020/02/21/CSAPP-archlab" target="_blank" rel="noopener noreferrer">CSAPP - archlab</a></p><p><a href="https://github.com/elainafan/Introduction-to-Computer-Systems-2025Fall-PKU" target="_blank" rel="noopener noreferrer">Introduction-to-Computer-Systems-2025Fall-PKU</a></p></div><!----><!----><div class="vp-doc-copyright" data-v-9999e088><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-061688d6><a href="#doc-copyright" class="header-anchor" data-v-061688d6><span data-v-061688d6><!--[-->版权所有<!--]--></span></a></h2><div class="vp-copyright" data-v-10ae089b><span class="copyright-mask" data-v-10ae089b></span><p data-v-10ae089b><span data-v-10ae089b>版权归属：</span><a class="vp-link link no-icon vp-external-link-icon" href="https://github.com/Staaaaaaaaar" target="_blank" rel="noreferrer" data-v-10ae089b><!--[-->Staaaaaaaaar<!--]--></a></p><!----><p data-v-10ae089b><span data-v-10ae089b>许可证：</span><a class="vp-link link no-icon vp-external-link-icon" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer" data-v-10ae089b><!--[-->署名-非商业性-相同方式共享 4.0 国际 (CC-BY-NC-SA-4.0)<!--]--></a><!--[--><span class="vpi-license-cc" data-v-10ae089b></span><span class="vpi-license-by" data-v-10ae089b></span><span class="vpi-license-nc" data-v-10ae089b></span><span class="vpi-license-sa" data-v-10ae089b></span><!--]--></p></div></div><footer class="vp-doc-footer" data-v-9999e088 data-v-c7949b5f><!--[--><!--]--><div class="edit-info" data-v-c7949b5f><div class="edit-link" data-v-c7949b5f><a class="vp-link link no-icon vp-external-link-icon edit-link-button" href="https://github.com/staaaaaaaaar/staaaaaaaaar.github.io/edit/main/docs/blog/实验/ics-archlab.md" target="_blank" rel="noreferrer" data-v-c7949b5f><!--[--><span class="vpi-square-pen edit-link-icon" aria-label="edit icon" data-v-c7949b5f></span> 编辑此页<!--]--></a></div><!----></div><div class="contributors" aria-label="Contributors" data-v-c7949b5f><span class="contributors-label" data-v-c7949b5f>贡献者: </span><span class="contributors-info" data-v-c7949b5f><!--[--><!--[--><span class="contributor" data-v-c7949b5f>Staaaaaaaaar</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-c7949b5f><div class="pager" data-v-c7949b5f><a class="vp-link link pager-link prev" href="/article/3b70vdzn/" data-v-c7949b5f><!--[--><span class="desc" data-v-c7949b5f>上一页</span><span class="title" data-v-c7949b5f><!----><span data-v-c7949b5f>ICS - Cache Lab | “百发百中”的缓存</span></span><!--]--></a></div><div class="pager" data-v-c7949b5f><a class="vp-link link pager-link next" href="/article/n3r0iall/" data-v-c7949b5f><!--[--><span class="desc" data-v-c7949b5f>下一页</span><span class="title" data-v-c7949b5f><!----><span data-v-c7949b5f>ICS - Attack Lab | 缓冲区溢出，你看你干的好事！</span></span><!--]--></a></div></nav></footer></div><!--]--></main><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-91d48f1e style="display:none;" data-v-c8d1f8c7><span class="percent" data-allow-mismatch data-v-c8d1f8c7>0%</span><span class="show icon vpi-back-to-top" data-v-c8d1f8c7></span><svg aria-hidden="true" data-v-c8d1f8c7><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-c8d1f8c7></circle></svg></button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="sign down" class="vp-sign-down" aria-hidden="true" data-v-91d48f1e style="display:none;" data-v-791023f6><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" data-v-791023f6><path d="m19 11l-7 6l-7-6" data-v-791023f6></path><path d="m19 5l-7 6l-7-6" opacity="0.6" data-v-791023f6></path></g></svg><footer class="vp-footer" vp-footer data-v-91d48f1e data-v-39a68a3a><!--[--><div class="container" data-v-39a68a3a><div class="message" data-v-39a68a3a>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></div><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-Db1faIqK.js" defer></script></body></html>